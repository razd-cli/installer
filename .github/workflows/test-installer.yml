name: Test Installer Scripts

on:
  push:
    branches: [main]
    paths:
      - "install.ps1"
      - "install.sh"
      - ".github/workflows/test-installer.yml"
  pull_request:
    branches: [main]
    paths:
      - "install.ps1"
      - "install.sh"
      - ".github/workflows/test-installer.yml"
  workflow_dispatch:

# Set GITHUB_TOKEN for all jobs to avoid rate limiting
env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  test-windows:
    name: Windows (PowerShell)
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run installer script
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Testing install.ps1 on Windows..."
          & .\install.ps1

      - name: Verify mise installation
        shell: pwsh
        run: |
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
          mise --version
          Write-Host "✓ mise is installed"

      - name: Verify razd installation
        shell: pwsh
        run: |
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
          # Use mise exec to run razd
          mise exec -- razd --version
          # Also test with mise shims (add shims to PATH)
          $shimPath = Join-Path $env:LOCALAPPDATA "mise\shims"
          if (Test-Path $shimPath) {
            $env:Path = "$shimPath;$env:Path"
          }
          razd --version
          Write-Host "✓ razd is installed"

  test-ubuntu:
    name: Ubuntu (Bash)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run installer script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Testing install.sh on Ubuntu..."
          chmod +x install.sh
          ./install.sh

      - name: Verify mise installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mise --version
          echo "✓ mise is installed"

      - name: Verify razd installation
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          # Use mise exec since source ~/.bashrc doesn't work in non-interactive CI shell
          mise exec -- razd --version
          mise exec -- razd -v
          echo "✓ razd is installed"

  test-macos:
    name: macOS (Bash)
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run installer script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Testing install.sh on macOS..."
          chmod +x install.sh
          ./install.sh

      - name: Verify mise installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mise --version
          echo "✓ mise is installed"

      - name: Verify razd installation
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          # Use mise exec since source ~/.bashrc doesn't work in non-interactive CI shell
          mise exec -- razd --version
          mise exec -- razd -v
          echo "✓ razd is installed"

  test-macos-arm64:
    name: macOS ARM64 (Bash)
    runs-on: macos-14 # Apple Silicon runner
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run installer script
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Testing install.sh on macOS ARM64..."
          chmod +x install.sh
          ./install.sh

      - name: Verify mise installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mise --version
          echo "✓ mise is installed"

      - name: Verify razd installation
        shell: bash
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          # Use mise exec since source ~/.bashrc doesn't work in non-interactive CI shell
          mise exec -- razd --version
          mise exec -- razd -v
          echo "✓ razd is installed"

  test-curl-install:
    name: Test curl | bash installation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Start local HTTP server
        run: |
          python3 -m http.server 8080 &
          sleep 2

      - name: Test curl installation method
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Testing curl | bash installation method..."
          curl -fsSL http://localhost:8080/install.sh | bash

      - name: Verify installation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mise --version
          # Use mise exec since source ~/.bashrc doesn't work in non-interactive CI shell
          mise exec -- razd --version
          echo "✓ curl | bash installation works"

  test-irm-install:
    name: Test irm | iex installation (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test irm | iex installation method
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Testing irm | iex installation method..."
          # Start HTTP server in background
          $serverJob = Start-Process -FilePath "python" -ArgumentList "-m", "http.server", "8080" -WorkingDirectory $PWD -PassThru -WindowStyle Hidden
          Start-Sleep -Seconds 5

          try {
            # Test that server is running
            $response = Invoke-WebRequest -Uri "http://localhost:8080/install.ps1" -UseBasicParsing -TimeoutSec 10
            Write-Host "Server is running, content length: $($response.Content.Length)"
            
            # Run the installer
            Invoke-RestMethod -Uri "http://localhost:8080/install.ps1" | Invoke-Expression
          }
          finally {
            # Stop the server
            if ($serverJob -and !$serverJob.HasExited) {
              Stop-Process -Id $serverJob.Id -Force -ErrorAction SilentlyContinue
            }
          }

      - name: Verify installation
        shell: pwsh
        run: |
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
          mise --version
          mise exec -- razd --version
          # Also test with mise shims
          $shimPath = Join-Path $env:LOCALAPPDATA "mise\shims"
          if (Test-Path $shimPath) {
            $env:Path = "$shimPath;$env:Path"
          }
          razd -v
          Write-Host "✓ irm | iex installation works"
